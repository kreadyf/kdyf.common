# ============================================================================
# Workflow: Test, Build and NuGet Deploy
# ============================================================================
# This workflow runs on every push or pull request to the main branch.
#
# Workflow steps:
#   1. test_and_build: Restore, build and run tests
#   2. publish: Pack and publish NuGet packages (only on push to main)
#
# Published packages:
#   - kdyf.Notifications
#   - kdyf.Notifications.Redis
#   - kdyf.Operations
#
# Requirements:
#   - NUGET_API_KEY secret must be configured in the repository
# ============================================================================

name: Test, Build and NuGet Deploy

# ============================================================================
# Triggers: Define when the workflow runs
# ============================================================================
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# ============================================================================
# Jobs: Define the jobs to execute
# ============================================================================
jobs:
  # --------------------------------------------------------------------------
  # Job: test_and_build
  # --------------------------------------------------------------------------
  test_and_build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    # - name: Test
    #   run: dotnet test --no-build --configuration Release --verbosity normal

  # --------------------------------------------------------------------------
  # Job: publish
  # --------------------------------------------------------------------------
  publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test_and_build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    # ----------------------------------------------------------------------
    # Pack NuGet packages
    # ----------------------------------------------------------------------
    - name: Pack kdyf.Notifications
      run: dotnet pack src/kdyf.Notifications/kdyf.Notifications.csproj --configuration Release --output ./nuget_packages

    - name: Pack kdyf.Notifications.Redis
      run: dotnet pack src/kdyf.Notifications.Redis/kdyf.Notifications.Redis.csproj --configuration Release --output ./nuget_packages

    - name: Pack kdyf.Operations
      run: dotnet pack src/kdyf.Operations/kdyf.Operations.csproj --configuration Release --output ./nuget_packages

    # ----------------------------------------------------------------------
    # Verify NUGET_API_KEY secret
    # ----------------------------------------------------------------------
    - name: Verify NUGET_API_KEY
      run: |
        if [ -z "${{ secrets.NUGET_API_KEY }}" ]; then
          echo "ERROR: NUGET_API_KEY is not defined"
          exit 1
        else
          echo "NUGET_API_KEY is defined"
        fi

    # ----------------------------------------------------------------------
    # Publish packages individually to NuGet.org
    # ----------------------------------------------------------------------
    - name: Push kdyf.Notifications
      run: dotnet nuget push ./nuget_packages/kdyf.Notifications.*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY_DEVELOPERS }} --skip-duplicate

    - name: Push kdyf.Notifications.Redis
      run: dotnet nuget push ./nuget_packages/kdyf.Notifications.Redis.*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY_DEVELOPERS }} --skip-duplicate

    - name: Push kdyf.Operations
      run: dotnet nuget push ./nuget_packages/kdyf.Operations.*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate
